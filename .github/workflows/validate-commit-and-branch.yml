name: üîç Validate PR Format (branch, commits, description)

on:
  pull_request:
    types: [opened, reopened, synchronize, edited]

jobs:
  validate:
    name: Validate branch, commits, and PR description
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # –ü–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –±–∞—á–∏—Ç–∏ —ñ—Å—Ç–æ—Ä—ñ—é –∑–º—ñ–Ω

      # ------------------------------
      # 1Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞–∑–≤–∏ –≥—ñ–ª–∫–∏
      # ------------------------------
      - name: ü™µ Check branch name format
        run: |
          BRANCH="${{ github.head_ref }}"
          echo "üîç Checking branch name: $BRANCH"

          # –§–æ—Ä–º–∞—Ç: TM-999/short-description
          if [[ ! "$BRANCH" =~ ^TM-[0-9]+\/[a-z0-9._-]+$ ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–µ —ñ–º'—è –≥—ñ–ª–∫–∏!"
            echo "‚úÖ –§–æ—Ä–º–∞—Ç –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏: TM-<–Ω–æ–º–µ—Ä –∑–∞–¥–∞—á—ñ>/<–∫–æ—Ä–æ—Ç–∫–∏–π-–æ–ø–∏—Å>"
            echo "–ü—Ä–∏–∫–ª–∞–¥: TM-123/fix-auth-error"
            exit 1
          fi

          echo "‚úÖ Branch name is valid!"

      # ------------------------------
      # 2Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–º–º—ñ—Ç-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å
      # ------------------------------
      - name: üßæ Check commit messages
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          COMMITS=$(git log --pretty=format:%s $BASE_SHA..$HEAD_SHA)

          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –∫–æ–º–º—ñ—Ç–∏ –º—ñ–∂ $BASE_SHA –∏ $HEAD_SHA"
          echo "-------------------------------------------"
          echo "$COMMITS"
          echo "-------------------------------------------"

          INVALID=0
          while IFS= read -r COMMIT; do
            if [[ ! "$COMMIT" =~ ^TM-[0-9]+:\  ]]; then
              echo "‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –∫–æ–º—ñ—Ç: \"$COMMIT\""
              echo "‚úÖ –§–æ—Ä–º–∞—Ç –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏: TM-<–Ω–æ–º–µ—Ä_–∑–∞–¥–∞—á—ñ>: –æ–ø–∏—Å"
              echo "–ü—Ä–∏–∫–ª–∞–¥: TM-123: –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è"
              INVALID=1
            else
              echo "‚úÖ $COMMIT"
            fi
          done <<< "$COMMITS"

          if [ "$INVALID" -eq 1 ]; then
            echo "üö´ –ó–Ω–∞–π–¥–µ–Ω–æ –Ω–µ–∫–æ—Ä–µ–∫—Ç–Ω—ñ –∫–æ–º–º—ñ—Ç–∏"
            exit 1
          fi

          echo "‚úÖ –£—Å—ñ –∫–æ–º—ñ—Ç–∏ –∫–æ—Ä–µ–∫—Ç–Ω—ñ!"

      # ------------------------------
      # 3Ô∏è‚É£ –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–ø–∏—Å—É PR
      # ------------------------------
      - name: üìù Check PR description format
        run: |
          BODY="${{ github.event.pull_request.body }}"
          echo "üîç –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –æ–ø–∏—Å PR:"
          echo "$BODY"

          # –§–æ—Ä–º–∞—Ç: TM-999: –æ–ø–∏—Å –∑–∞–¥–∞—á—ñ
          if [[ ! "$BODY" =~ ^TM-[0-9]+:\  ]]; then
            echo "‚ùå –ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –æ–ø–∏—Å PR!"
            echo "‚úÖ –§–æ—Ä–º–∞—Ç –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏: TM-<–Ω–æ–º–µ—Ä_–∑–∞–¥–∞—á—ñ>: –æ–ø–∏—Å"
            echo "–ü—Ä–∏–∫–ª–∞–¥: TM-123: –¥–æ–¥–∞–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"
            exit 1
          fi

          echo "‚úÖ –û–ø–∏—Å PR –∫–æ—Ä–µ–∫—Ç–Ω–æ!"
