name: Build and Notify

on:
  workflow_run:
    workflows: ["üîç Validate PR Format (branch, commits, description)"]
    types:
      - completed

jobs:
  build-and-test:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    env:
      ADMIN_ID: ${{ secrets.ADMIN_ID }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      DB_URL: ${{ secrets.DB_URL }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      PORT: ${{ secrets.PORT }}
      PRIVATE_KEY_B64: ${{ secrets.PRIVATE_KEY_B64 }}
      PUBLIC_KEY_B64: ${{ secrets.PUBLIC_KEY_B64 }}
      REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install root dependencies
        run: yarn install --frozen-lockfile

      - name: Create .env for server
        run: |
          echo "ADMIN_ID=${{ secrets.ADMIN_ID }}" >> server/.env
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> server/.env
          echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}" >> server/.env
          echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" >> server/.env
          echo "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}" >> server/.env
          echo "DB_URL=${{ secrets.DB_URL }}" >> server/.env
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> server/.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> server/.env
          echo "PORT=${{ secrets.PORT }}" >> server/.env
          echo "REFRESH_SECRET=${{ secrets.REFRESH_SECRET }}" >> server/.env

      - name: Create PEM key files
        run: |
          echo "${{ secrets.PRIVATE_KEY_B64 }}" | base64 -d > server/privateKey.pem
          echo "${{ secrets.PUBLIC_KEY_B64 }}" | base64 -d > server/publicKey.pem

      - name: Install and Build Backend
        run: |
          cd server
          yarn install --frozen-lockfile

      - name: Install and Build Frontend
        run: |
          cd client
          yarn install --frozen-lockfile
          yarn build

  notify:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Set PR variables from workflow_run
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

          PR_JSON=$(jq '.[0]' <(jq '.workflow_run.pull_requests' "$GITHUB_EVENT_PATH"))
      
          PR_NUMBER=$(echo "$PR_JSON" | jq -r '.number')
          PR_ACTION=$(echo "$PR_JSON" | jq -r '.action // "opened"')
          PR_MERGED=$(echo "$PR_JSON" | jq -r '.merged')
          PR_TITLE=$(echo "$PR_JSON" | jq -r '.title')
          PR_BODY=$(echo "$PR_JSON" | jq -r '.body')
          PR_USER=$(echo "$PR_JSON" | jq -r '.user.login')
          PR_HEAD=$(echo "$PR_JSON" | jq -r '.head.ref')
          PR_BASE=$(echo "$PR_JSON" | jq -r '.base.ref')
      
          echo "PR_NUMBER=$PR_NUMBER" >> $GITHUB_ENV
          echo "PR_ACTION=$PR_ACTION" >> $GITHUB_ENV
          echo "PR_MERGED=$PR_MERGED" >> $GITHUB_ENV
          echo "PR_TITLE=$PR_TITLE" >> $GITHUB_ENV
          echo "PR_BODY=$PR_BODY" >> $GITHUB_ENV
          echo "PR_USER=$PR_USER" >> $GITHUB_ENV
          echo "PR_HEAD=$PR_HEAD" >> $GITHUB_ENV
          echo "PR_BASE=$PR_BASE" >> $GITHUB_ENV

      # -----------------------------
      # PR –≤—ñ–¥–∫—Ä–∏—Ç–∏–π
      # -----------------------------
      - name: üîµ Notify when PR opened or reopened
        if: ${{ env.PR_ACTION == 'opened' || env.PR_ACTION == 'reopened' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY"
          fi

          MESSAGE=$(cat <<EOF
          üîµ –ù–æ–≤–∏–π Pull Request –≤—ñ–¥ *$PR_USER*
          
          *–ù–∞–∑–≤–∞:* $PR_TITLE
          *–ì—ñ–ª–∫–∞:* $PR_HEAD ‚Üí $PR_BASE
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)

          -----------------------------------------------------------
          üí° –ê —Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤ —Å–≤—ñ–π –∫–æ–¥ —ñ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á—ñ?
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–º–µ—Ä–∂–µ–Ω
      # -----------------------------
      - name: üü¢ Notify when PR merged
        if: ${{ env.PR_ACTION == 'closed' && env.PR_MERGED == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY\n"
          fi

          MESSAGE=$(cat <<EOF
          üü¢ Pull Request *#$PR_NUMBER* –±—É–≤ –∑–ª–∏—Ç–∏–π –≤ –≥—ñ–ª–∫—É *$PR_BASE*
          
          –ê–≤—Ç–æ—Ä: $PR_USER
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)
          
          üëâ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ \`git pull\`!
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–∫—Ä–∏—Ç–∏–π –±–µ–∑ merge
      # -----------------------------
      - name: üî¥ Notify when PR closed without merge
        if: ${{ env.PR_ACTION == 'closed' && env.PR_MERGED == 'false' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY"
          fi

          MESSAGE=$(cat <<EOF
          üî¥ Pull Request *#$PR_NUMBER* –±—É–≤ –∑–∞–∫—Ä–∏—Ç–∏–π –±–µ–∑ merge
          
          –ê–≤—Ç–æ—Ä –∑–∞–∫—Ä–∏—Ç–æ–≥–æ PR: *$PR_USER*
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"
