name: PR Validation

on:
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    env:
      ADMIN_ID: ${{ secrets.ADMIN_ID }}
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      CLOUDINARY_API_KEY: ${{ secrets.CLOUDINARY_API_KEY }}
      CLOUDINARY_API_SECRET: ${{ secrets.CLOUDINARY_API_SECRET }}
      CLOUDINARY_CLOUD_NAME: ${{ secrets.CLOUDINARY_CLOUD_NAME }}
      DB_URL: ${{ secrets.DB_URL }}
      GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      JWT_SECRET: ${{ secrets.JWT_SECRET }}
      PORT: ${{ secrets.PORT }}
      PRIVATE_KEY_B64: ${{ secrets.PRIVATE_KEY_B64 }}
      PUBLIC_KEY_B64: ${{ secrets.PUBLIC_KEY_B64 }}
      REFRESH_SECRET: ${{ secrets.REFRESH_SECRET }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Установка зависимостей root (если есть)
      - name: Install root dependencies
        run: yarn install --frozen-lockfile

      # Создание .env файла для сервера
      - name: Create .env for server
        run: |
          echo "ADMIN_ID=${{ secrets.ADMIN_ID }}" >> server/.env
          echo "BOT_TOKEN=${{ secrets.BOT_TOKEN }}" >> server/.env
          echo "CLOUDINARY_API_KEY=${{ secrets.CLOUDINARY_API_KEY }}" >> server/.env
          echo "CLOUDINARY_API_SECRET=${{ secrets.CLOUDINARY_API_SECRET }}" >> server/.env
          echo "CLOUDINARY_CLOUD_NAME=${{ secrets.CLOUDINARY_CLOUD_NAME }}" >> server/.env
          echo "DB_URL=${{ secrets.DB_URL }}" >> server/.env
          echo "GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}" >> server/.env
          echo "JWT_SECRET=${{ secrets.JWT_SECRET }}" >> server/.env
          echo "PORT=${{ secrets.PORT }}" >> server/.env
          echo "REFRESH_SECRET=${{ secrets.REFRESH_SECRET }}" >> server/.env

      # Создание PEM файлов
      - name: Create PEM key files
        run: |
          echo "${{ secrets.PRIVATE_KEY_B64 }}" | base64 -d > server/privateKey.pem
          echo "${{ secrets.PUBLIC_KEY_B64 }}" | base64 -d > server/publicKey.pem

      # Установка зависимостей и сборка backend
      - name: Install and Build Backend
        run: |
          cd server
          yarn install --frozen-lockfile
          yarn build

      # Установка зависимостей и сборка frontend
      - name: Install and Build Frontend
        run: |
          cd client
          yarn install --frozen-lockfile
          yarn build