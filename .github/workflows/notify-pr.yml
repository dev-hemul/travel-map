name: Notify team on PR events
on:
  pull_request:
    types: [opened, reopened, closed]
  issue_comment:
    types: [created]

jobs:
  notify:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # PR –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç
      # -----------------------------
      - name: üîµ Notify when PR opened or reopened
        if: ${{ github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'reopened') }}
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"
          DESC_TEXT=""
          if [ -n "$DESCRIPTION" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $DESCRIPTION\n"
          fi

          MESSAGE=$(cat <<EOF
          üîµ –ù–æ–≤–∏–π Pull Request –≤—ñ–¥ *${{ github.event.pull_request.user.login }}*

          *–ù–∞–∑–≤–∞:* ${{ github.event.pull_request.title }}
          *–ì—ñ–ª–∫–∞:* ${{ github.event.pull_request.head.ref }} ‚Üí ${{ github.event.pull_request.base.ref }}
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](${{ github.event.pull_request.html_url }})

          -----------------------------------------------------------
          üí° –ê —Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤ —Å–≤—ñ–π –∫–æ–¥ —ñ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á—ñ?
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–º–µ—Ä–∂–µ–Ω
      # -----------------------------
      - name: üü¢ Notify when PR merged
        if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true }}
        run: |
          DESCRIPTION="${{ github.event.pull_request.body }}"
          DESC_TEXT=""
          if [ -n "$DESCRIPTION" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $DESCRIPTION\n"
          fi

          MESSAGE=$(cat <<EOF
          üü¢ Pull Request *#${{ github.event.pull_request.number }}* –±—É–≤ –∑–ª–∏—Ç–∏–π –≤ –≥—ñ–ª–∫—É *${{ github.event.pull_request.base.ref }}*

          –ê–≤—Ç–æ—Ä: ${{ github.event.pull_request.user.login }}
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](${{ github.event.pull_request.html_url }})

          üëâ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ \`git pull\`!
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ merge
      # -----------------------------
      - name: üî¥ Notify when PR closed without merge
        if: ${{ github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == false }}
        run: |
          NUMBER=${{ github.event.pull_request.number }}
          DESCRIPTION="${{ github.event.pull_request.body }}"
          DESC_TEXT=""
          if [ -n "$DESCRIPTION" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $DESCRIPTION\n"
          fi

          MESSAGE=$(cat <<EOF
          üî¥ Pull Request *#${NUMBER}* –±—É–≤ –∑–∞–∫—Ä–∏—Ç–∏–π –±–µ–∑ merge
          
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](${{ github.event.pull_request.html_url }})
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ PR (–≤–∫–ª—é—á–∞—è Close with comment)
      # -----------------------------
      - name: üìù Notify comment on PR
        if: ${{ github.event_name == 'issue_comment' && github.event.issue.pull_request }}
        run: |
          COMMENT_BODY="${{ github.event.comment.body }}"
          COMMENT_AUTHOR="${{ github.event.comment.user.login }}"
          PR_NUMBER="${{ github.event.issue.number }}"
          PR_URL="https://github.com/${{ github.repository }}/pull/${PR_NUMBER}}"

          # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø—É—Å—Ç—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
          if [ -z "$COMMENT_BODY" ]; then
            exit 0
          fi

          COMMENT_TEXT=$(printf "üìù –ö–æ–º–µ–Ω—Ç–∞—Ä PR (–≤—ñ–¥ @%s):\n```\n%s\n```" "$COMMENT_AUTHOR" "$COMMENT_BODY")

          MESSAGE=$(cat <<EOF
          $COMMENT_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR]($PR_URL)
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TG_BOT_TOKEN }}/sendMessage" \
            --data-urlencode "chat_id=${{ secrets.TG_CHAT_ID }}" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"
