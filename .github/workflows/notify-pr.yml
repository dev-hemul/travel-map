name: Notify team on PR events

on:
  workflow_run:
    workflows: ["PR Validation"]  # –∏–º—è workflow, –∫–æ—Ç–æ—Ä—ã–π –±–∏–ª–¥–∏—Ç PR
    types:
      - completed

jobs:
  notify:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}  # —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –±–∏–ª–¥ —É—Å–ø–µ—à–Ω—ã–π
    runs-on: ubuntu-latest

    steps:
      - name: Set environment variables
        run: |
          echo "PR_NUMBER=$(jq -r '.workflow_run.pull_requests[0].number' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_ACTION=$(jq -r '.workflow_run.pull_requests[0].action' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_MERGED=$(jq -r '.workflow_run.pull_requests[0].merged' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_TITLE=$(jq -r '.workflow_run.pull_requests[0].title' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_BODY=$(jq -r '.workflow_run.pull_requests[0].body' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_USER=$(jq -r '.workflow_run.pull_requests[0].user.login' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_HEAD=$(jq -r '.workflow_run.pull_requests[0].head.ref' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV
          echo "PR_BASE=$(jq -r '.workflow_run.pull_requests[0].base.ref' < $GITHUB_EVENT_PATH)" >> $GITHUB_ENV

      # -----------------------------
      # PR –æ—Ç–∫—Ä—ã—Ç –∏–ª–∏ –ø–µ—Ä–µ–æ—Ç–∫—Ä—ã—Ç
      # -----------------------------
      - name: üîµ Notify when PR opened or reopened
        if: ${{ env.PR_ACTION == 'opened' || env.PR_ACTION == 'reopened' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY"
          fi

          MESSAGE=$(cat <<EOF
          üîµ –ù–æ–≤–∏–π Pull Request –≤—ñ–¥ *$PR_USER*
          
          *–ù–∞–∑–≤–∞:* $PR_TITLE
          *–ì—ñ–ª–∫–∞:* $PR_HEAD ‚Üí $PR_BASE
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)

          -----------------------------------------------------------
          üí° –ê —Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤ —Å–≤—ñ–π –∫–æ–¥ —ñ —Ç–µ–∫—Å—Ç –∑–∞–¥–∞—á—ñ?
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–º–µ—Ä–∂–µ–Ω
      # -----------------------------
      - name: üü¢ Notify when PR merged
        if: ${{ env.PR_ACTION == 'closed' && env.PR_MERGED == 'true' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY\n"
          fi

          MESSAGE=$(cat <<EOF
          üü¢ Pull Request *#$PR_NUMBER* –±—É–≤ –∑–ª–∏—Ç–∏–π –≤ –≥—ñ–ª–∫—É *$PR_BASE*
          
          –ê–≤—Ç–æ—Ä: $PR_USER
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)
          
          üëâ –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑—Ä–æ–±–∏—Ç–∏ \`git pull\`!
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"

      # -----------------------------
      # PR –∑–∞–∫—Ä—ã—Ç –±–µ–∑ merge
      # -----------------------------
      - name: üî¥ Notify when PR closed without merge
        if: ${{ env.PR_ACTION == 'closed' && env.PR_MERGED == 'false' }}
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: |
          DESC_TEXT=""
          if [ -n "$PR_BODY" ]; then
            DESC_TEXT="*–û–ø–∏—Å:* $PR_BODY"
          fi

          MESSAGE=$(cat <<EOF
          üî¥ Pull Request *#$PR_NUMBER* –±—É–≤ –∑–∞–∫—Ä–∏—Ç–∏–π –±–µ–∑ merge
          
          –ê–≤—Ç–æ—Ä –∑–∞–∫—Ä–∏—Ç–æ–≥–æ PR: *$PR_USER*
          $DESC_TEXT
          üîó [–î–∏–≤–∏—Ç–∏—Å—å PR](https://github.com/${{ github.repository }}/pull/$PR_NUMBER)
          EOF
          )

          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            --data-urlencode "chat_id=$TELEGRAM_CHAT_ID" \
            --data-urlencode "parse_mode=Markdown" \
            --data-urlencode "text=$MESSAGE"